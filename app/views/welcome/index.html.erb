<div id='mealModal'></div>
<div class='row'>
  <div class='col-sm-4'>
    <div id='todayCalendar'></div>
  </div>
  <div class='col-sm-4'>
    <div id='tomorrowCalendar'></div>
  </div>
  <div class='col-sm-4'>
    <canvas id='pie' height='200' width='200'></canvas>
  </div>
</div>
<div class='row'>
  <div class='col-sm-4'>
    <canvas id='histogram' height='200' width='200'></canvas>
  </div>
</div>

<script>
  $(function() {
    $('#todayCalendar').fullCalendar({
        events: '/calendar',
        defaultView: 'basicDay',
        header: { left: 'title', center: false, right: false },
        height: 'auto',
        eventClick: function(e) { openModal(e); }
    });

    $('#tomorrowCalendar').fullCalendar({
      events: '/calendar',
      defaultView: 'basicDay',
      header: { left: 'title', center: false, right: false },
      height: 'auto',
      eventClick: function(e) { openModal(e); }
    })
    .fullCalendar('next');

    $.ajax({
      method: 'get',
      url: '/response_pie',
      success: function(response) {
        var ctx = $('#pie');
        var myChart = new Chart(ctx, {
          type: 'pie',
          data: {
            datasets: [{
                data: response.data,
                backgroundColor: ['#4a010c', '#960038', '#f60239', '#4c9d49', '#005b00', '#000000'],
                label: 'Total Score Distribution'
            }],
            labels: response.labels
          }
        });
      },
      error: function() {
        console.log("Reponse pie ajax failed dude");
      }
    });

    $.ajax({
      method: 'get',
      url: '/meal_type_histogram',
      success: function(response) {
        var ctx = $('#histogram');
        var myChart = new Chart(ctx, {
          type: 'bar',
          data: {
            datasets: [{
              label: 'Average Score by Meal type',
              data: response.data,
              backgroundColor: ['#FF0000', '#4B0082', '#0000FF']
            }],
            labels: response.labels
          },
          options: { scales: { yAxes: [{ ticks: { beginAtZero: true } }] } }
        });
      },
      error: function() {
        console.log("meal_type_histogram ajax failed dude");
      }
    })
  });

  function openModal(event) {
    $('#mealModal').replaceWith('<%= j render 'meals/meal-modal' %>');
    const url = event.rating ? `ratings/${event.rating.id}/edit` : "ratings/new";
    $.ajax({
      method: 'get',
      url: url,
      dataType: 'html',
      success: function(data) {
        $('#mealModal .modal-body').append(data);
        $('#rating_meal_id').val(event.id);
        $('#mealModal .modal-title').html(event.title);
        $('#mealModal').modal('show');
      },
      error: function() {
        alert("Fail! You suck!");
      }
    });
  }
</script>
